<div class="container-listado">

  <div class="contenedor-buscador-filtros">

    <div class="contenedor-filtros" *ngIf="userRole !== 2">
      <h3>Filtrar por local:</h3>
      <select [(ngModel)]="filtroLocal" (change)="obtenerPedidos()" class="dropdown-filtro">
        <option [ngValue]="null">Todos</option>
        <option *ngFor="let local of locales" [ngValue]="local.id">
          {{ local.nombre }}
        </option>
      </select>
    </div>


    <div class="contenedor-filtros">
      <h3>Tipo de Pedido:</h3>
      <select [(ngModel)]="filtroTipoPedido" (change)="obtenerPedidos()" class="dropdown-filtro">
        <option [ngValue]="null">Por defecto</option>
        <option *ngFor="let tipo of tiposDePedido" [ngValue]="tipo.iD_TipoPedido">
          {{ tipo.nombre }}
        </option>
      </select>
    </div>

    <div class="contenedor-filtros">
      <h3>Estado:</h3>
      <select [(ngModel)]="filtroEstado" (change)="obtenerPedidos()" class="dropdown-filtro">
        <option [ngValue]="null">Todos</option>
        <option value="Pendiente">Pendiente</option>
        <option value="Enviado">Enviado</option>
        <option value="Completado">Completado</option>

      </select>
    </div>

    <div class="contenedor-filtros">
      <h3>Desde:</h3>
      <input type="date" [(ngModel)]="filtroFechaDesde" (change)="obtenerPedidos()" class="dropdown-filtro" />
    </div>

    <div class="contenedor-filtros">
      <h3>Hasta:</h3>
      <input type="date" [(ngModel)]="filtroFechaHasta" (change)="obtenerPedidos()" class="dropdown-filtro" />
    </div>

  </div>


  <div>
    <div class="table-container overflow-x-auto">
      <table class="table-auto w-full border border-gray-200 shadow-lg rounded-lg">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="px-4 py-2 text-left border-b">ID Pedido</th>
            <th class="px-4 py-2 text-left border-b">Tipo Pedido</th>
            <th class="px-4 py-2 text-left border-b">Local</th>
            <th class="px-4 py-2 text-left border-b">Estado</th>
            <th class="px-4 py-2 text-left border-b">Fecha</th>
            <th class="px-4 py-2 text-left border-b">Fecha de Entrega</th>
            <th class="px-4 py-2 text-left border-b">Acciones</th>
          </tr>
        </thead>
        <tbody class="text-gray-700">
          <tr *ngFor="let pedido of pedidos" class="bg-white hover:bg-gray-50">
            <td class="px-4 py-2 border-b">{{ pedido.iD_Pedido }}</td>
            <td class="px-4 py-2 border-b">{{ obtenerNombreTipoPedido(pedido.iD_TipoPedido) }}</td>
            <td class="px-4 py-2 border-b">{{ obtenerNombreLocal(pedido.iD_Local.valueOf()) }}</td>
            <td class="px-4 py-2 border-b">{{ pedido.estado }}</td>
            <td class="px-4 py-2 border-b">{{ pedido.fecha | date: 'shortDate' }}</td>
            <td class="px-4 py-2 border-b">{{ pedido.fechaEntrega | date: 'shortDate' }}</td>
            <td class="px-4 py-2 border-b">
              <div class="dropdown">
                <button class="bg-gray-500 text-white px-3 py-1 rounded-lg shadow-md hover:bg-gray-800 dropdown-toggle"
                        type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Opciones
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item hover:bg-gray-100 cursor-pointer"
                       (click)="verDetallePedido(pedido.iD_Pedido)">Ver Detalle</a>
                  </li>
                  <li>
                    <a class="dropdown-item text-red-600 hover:bg-gray-100 cursor-pointer"
                       (click)="abrirModalEdicion(pedido)">Editar Pedido</a>
                  </li>

                </ul>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>




<!-- Offcanvas Detalle de Pedido -->
<div *ngIf="mostrarCanvas" class="fixed right-0 top-10 h-full w-[500px] md:w-[550px] bg-white shadow-lg overflow-y-auto flex flex-col z-50">
  <div class="p-4 relative pt-8 flex-1 overflow-y-auto mb-16">

    <!-- Botón de cierre -->
    <button (click)="mostrarCanvas = false"
            class="absolute top-8 right-4 text-gray-600 hover:text-gray-900 text-3xl font-bold">
      ✖
    </button>

    <!-- Título -->
    <div class="text-gray-900 text-xl font-bold text-center py-2 mb-4">
      Detalle del Pedido
    </div>

    <!-- Lista de artículos -->
    <div *ngIf="detallePedido && detallePedido.length > 0; else noData" class="overflow-y-auto space-y-2 flex-1">
      <div *ngFor="let detalle of detallePedido" class="flex items-center gap-4 border border-gray-300 rounded-lg p-3">
        <div>
          <div class="text-lg font-semibold">Artículo: {{ detalle.iD_Articulo }}</div>
          <div class="text-sm text-gray-700">Cantidad: {{ detalle.cantidad }}</div>
          <div class="text-base">{{ detalle.precio_Unitario | currency }}</div>
          <div class="text-lg font-bold text-green-600">
            {{ detalle.precio_Unitario * detalle.cantidad | currency }}
          </div>
        </div>
      </div>
    </div>

    <!-- Mensaje cuando no hay datos -->
    <ng-template #noData>
      <p class="text-center text-gray-500 text-lg">No hay artículos en este pedido.</p>
    </ng-template>
  </div>

  <!-- Totales -->
  <div *ngIf="detallePedido && detallePedido.length > 0" class="bg-gray-100 text-gray-800 py-3 px-6 w-full sticky bottom-10 shadow-md">
    <div class="text-lg">
      <div><strong>Subtotal: </strong><span class="text-1xl font-bold">{{ subtotal | currency }}</span></div>
      <div><strong>Total: </strong><span class="text-1xl font-bold text-gray-900">{{ total | currency }}</span></div>
    </div>
  </div>
</div>


<!-- Modal de Edición -->
<div *ngIf="mostrarModalEdicion && pedidoAEditar" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-[400px]">
    <h2 class="text-xl font-bold mb-4">Actualizar pedido N° {{pedidoAEditar.iD_Pedido}}</h2>

    <div class="mb-4">
      <label class="block text-gray-700 font-medium mb-1">Estado:</label>
      <select [(ngModel)]="pedidoAEditar.estado" class="w-full border rounded p-2">
        
        <option value="Pendiente">Pendiente</option>
        <option value="Enviado">Enviado</option>
        <option value="Completado">Completado</option>

      </select>
    </div>

    <div class="mb-4">
      <label class="block text-gray-700 font-medium mb-1">Fecha de Entrega:</label>
      <input type="date" [(ngModel)]="pedidoAEditar.fechaEntrega" class="w-full border rounded p-2" />
    </div>

    <div class="flex justify-end gap-2">
      <button (click)="cerrarModal()" class="bg-gray-300 text-gray-800 px-4 py-2 rounded">Cancelar</button>
      <button (click)="guardarCambiosPedido()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-800">Guardar</button>
    </div>
  </div>
</div>
